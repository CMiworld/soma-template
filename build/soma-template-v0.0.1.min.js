/*! soma-template - v0.0.1 - 2012-11-05
* http://www.soundstep.com/
* Copyright (c) 2012 Soundstep */
(function(e,t){"use strict";function l(e){return Object.prototype.toString.apply(e)==="[object Array]"}function c(e){return typeof e=="object"}function h(e){return typeof e=="string"}function p(e){return e?e.nodeType>0:!1}function d(e){return e&&e.nodeType&&e.nodeType===3}function v(e){return e&&typeof e=="function"}function m(e){return e!==null&&e!==t}function g(e){return e&&v(e.toString)&&e.toString()==="[object Expression]"}function y(e){return e&&v(e.toString)&&e.toString()==="[object Node]"}function b(e){return h(e)?!!e.match(f.func):!1}function w(e){return!e||!p(e.element)?!1:e.parent&&K.get(e.element)?!0:!1}function E(e){return e.replace(f.escape,"\\$&")}function S(e,t){var n="";t&&e.length>1&&(n="|\\"+e.substr(0,1)+"(?!\\"+e.substr(1,1)+")"),f.sequence=new RegExp(o.start()+".+?"+o.end()+"|[^"+o.start()+"]+"+n,"g"),f.token=new RegExp(o.start()+".*?"+o.end(),"g"),f.expression=new RegExp(o.start()+"|"+o.end(),"gm")}function x(e){return e.replace(f.trim,"")}function T(e){return e[0]===""&&e.shift(),e[e.length-1]===""&&e.pop(),e}function N(e){return e.replace(f.expression,"")}function C(e,t){if(!e.parentNode)return;e.parentNode.insertBefore(t,e)}function k(e,t){if(!e.parentNode)return;e.parentNode.insertBefore(t,e.nextSibling)}function L(e,t){document.documentElement.classList?L=function(e,t){e.classList.remove(t)}:L=function(e,t){if(!e||!e.className)return!1;var n=new RegExp("(^|\\s)"+t+"(\\s|$)","g");e.className=e.className.replace(n,"$2")},L(e,t)}function A(){var e=function(e,t){for(t=e="";e++<36;t+=e*51&52?(e^15?8^Math.random()*(e^20?16:4):4).toString(16):"-");return t},t={},n=function(t){if(!t)return;if(typeof t!="object")return t;var n;try{n=t.hashkey?t.hashkey:t.hashkey=e()}catch(r){}return n};return{put:function(e,r){t[n(e)]=r},get:function(e){return t[n(e)]},remove:function(e){delete t[n(e)]},getData:function(){return t},dispose:function(){for(var e in t)t[e]=null,delete t[e]}}}function O(e,t){var n=e.match(f.repeat);if(!n)return;var r=n[2],i=new J(r);return i.getValue(t)}function M(e,t,n){var r=e.match(f.repeat);if(!r)return;var i=r[1];t[i]=n}function _(e,t){var n=e.node||e.attribute.node,r=n.template.watchers,i=n.element,s=r.get(i);!s&&d(n.element)&&n.parent&&(s=r.get(n.parent.element));var o=s?s:r.get(e.pattern);if(v(o)){var u=o(e.value,t,e.pattern,n.scope,n,e.attribute);if(m(u))return u}return t}function D(e,n,r,i,s,o){var u=n.split("."),a=e;if(u[0]!==""){var l=-1,c=u.length;while(++l<c){if(!a)return e._parent?D(e._parent,n,r,i,s,o):t;a=a[u[l]]}}if(!a)return e._parent?D(e._parent,n,r,i,s,o):t;if(!s)return!m(a[r])&&e._parent?D(e._parent,n,r,i,s,o):a[r];var h=[];if(m(i))if(o)h=o;else{var l=-1,c=i.length;while(++l<c){var p=i[l];if(p.match(f.quote))h.push(p.replace(f.quote,""));else{var d=new J(p);h.push(d.getValue(e))}}}return v(a[r])?a[r].apply(null,h):e._parent?D(e._parent,n,r,i,s,h):t}function P(e){var t=e.split("(")[0];return t.substr(0,t.lastIndexOf("."))}function H(e){var t=e.split("(")[0];return t.substring(t.lastIndexOf(".")).replace(".","")}function B(e){return T(e.split(f.params))}function j(e,t,n){var r=new X(e,t);r.previousSibling=e.previousSibling,r.nextSibling=e.nextSibling;var i=[];for(var o,u,a,f=e.attributes,l=0,c=f&&f.length;l<c;l++)o=f[l],o.specified&&(u=o.name,a=o.value,u===s.attributes.skip&&(r.skip=a===""||a==="true"),!n&&u===s.attributes.repeat&&(r.repeater=a),(F(u+":"+a)||u===s.attributes.repeat||u===s.attributes.show||u===s.attributes.hide||u===s.attributes.href||a.indexOf(s.attributes.cloak)!==-1)&&i.push(new V(u,a,r)));return r.attributes=i,r}function F(e){var t=e.match(f.token);return t&&t.length>0}function I(e){return f.content.test(e)}function q(e){if(!e)return;var t=e.nodeType;return!e||!t?!1:t===8?!1:t===3&&!I(e.nodeValue)&&!F(e.nodeValue)?!1:!0}function R(e,t,n,r){if(!q(t))return;var i;r?(i=r,i.parent=n):i=j(t,n?n.scope:new W),i.template=e;if(i.skip)return;var s=t.firstChild;while(s){var o=R(e,s,i);o&&(o.parent=i,i.children.push(o)),s=s.nextSibling}return i}function U(e,t){z(e);for(var n in t)e[n]=t[n]}function z(e){for(var t in e)t.substr(0,1)!=="_"&&(e[t]=null,delete e[t])}function G(t,n){var r;if(h(t)){if(!p(n))throw new Error(e.template.errors.TEMPLATE_STRING_NO_ELEMENT);n.innerHTML=t,r=n}else{if(!p(t))throw new Error(e.template.errors.TEMPLATE_NO_PARAM);p(n)?(n.innerHTML=t.innerHTML,r=n):r=t}Y(r)&&Y(r).dispose();var i=new Q(r);return K.put(r,i),i}function Y(e){return p(e)?K.get(e):null}function Z(){for(var e in K.getData())K.get(e).render()}e.template=e.source||{},e.template.version="0.0.1";var n=e.template.errors={TEMPLATE_STRING_NO_ELEMENT:"Error in soma.template, a string template requirement a second parameter: an element target - soma.template.create('string', element)",TEMPLATE_NO_PARAM:"Error in soma.template, a template requires at least 1 parameter - soma.template.create(element)",REPEAT_WRONG_ARGUMENTS:"Error in soma.template, repeat attribute requires this syntax: 'item in items'."},r="{{",i="}}",s=e.template.settings=e.template.settings||{},o=s.tokens={start:function(e){return m(e)&&e!==""&&(r=E(e),S(e,!0)),r},end:function(e){return m(e)&&e!==""&&(i=E(e),S(e,!1)),i}},u=s.attributes={skip:"data-skip",repeat:"data-repeat",src:"data-src",href:"data-href",show:"data-show",hide:"data-hide",cloak:"data-cloak"},a=s.vars={index:"$index",key:"$key"},f={sequence:null,token:null,expression:null,escape:/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,trim:/^[\s+]+|[\s+]+$/g,repeat:/(.*)\s+in\s+(.*)/,func:/(.*)\((.*)\)/,params:/,\s+|,|\s+,\s+/,quote:/\"|\'/g,content:/[^.|^\s]/gm},W=function(e){function t(e){var t=n(e);return t._parent=this,this._children.push(t),t}function n(e){var n={_parent:null,_children:[],_createChild:function(e){return t.apply(n,arguments)}};if(e&&c(e))for(var r in e)n[r]=e[r];return n}return n(e)},X=function(e,t){this.element=e,this.scope=t,this.attributes=null,this.value=null,this.interpolation=null,this.invalidate=!1,this.skip=!1,this.repeater=null,this.parent=null,this.children=[],this.childrenRepeater=[],this.previousSibling=null,this.nextSibling=null,this.template=null,d(this.element)&&(this.value=this.element.nodeValue,this.interpolation=new $(this.value,this))};X.prototype={toString:function(){return"[object Node]"},dispose:function(){},getNode:function(e){var t;if(e===this.element)return this;if(this.childrenRepeater.length>0){var n=-1,r=this.childrenRepeater.length;while(++n<r){t=this.childrenRepeater[n].getNode(e);if(t)return t}}else{var i=-1,s=this.children.length;while(++i<s){t=this.children[i].getNode(e);if(t)return t}}return null},update:function(){if(w(this))return;m(this.interpolation)&&this.interpolation.update();if(m(this.attributes)){var e=-1,t=this.attributes.length;while(++e<t)this.attributes[e].interpolationName.update(),this.attributes[e].interpolationValue.update()}this.updateChildren()},updateChildren:function(){if(w(this)||this.repeater)return;var e=-1,t=this.children.length;while(++e<t)this.children[e].update()},invalidateData:function(){if(w(this))return;this.invalidate=!0;var e,t;if(this.attributes){e=-1,t=this.attributes.length;while(++e<t)this.attributes[e].invalidate=!0}e=-1,t=this.childrenRepeater.length;while(++e<t)this.childrenRepeater[e].invalidateData();e=-1,t=this.children.length;while(++e<t)this.children[e].invalidateData()},render:function(){if(w(this))return;this.invalidate&&(this.invalidate=!1,d(this.element)&&(this.element.nodeValue=this.interpolation.render()));if(this.attributes){var e=-1,t=this.attributes.length;while(++e<t)this.attributes[e].render()}this.repeater?this.renderRepeater():this.renderChildren()},renderChildren:function(){if(w(this))return;var e=-1,t=this.children.length;while(++e<t)this.children[e].render()},renderRepeater:function(){var e=O(this.repeater,this.scope);if(l(e)){var t=-1,n=e.length,r=this.childrenRepeater.length,i=n>r?n:r;while(++t<i)if(t<n){var s,o=this.childrenRepeater[t];if(!o){var u=this.element.cloneNode(!0),f=j(u,this.scope._createChild(),!0);f.parent=this,f.template=this.template,this.childrenRepeater[t]=f,M(this.repeater,f.scope,e[t]),f.scope[a.index]=t,R(this.template,u,this.parent,f),f.update(),f.render(),s?k(s,u):this.previousSibling?k(this.previousSibling,u):this.nextSibling?C(this.nextSibling,u):this.parent.element.appendChild(u),s=f.element}else M(this.repeater,o.scope,e[t]),o.scope[a.index]=t,o.update(),o.render(),s=o.element}else this.parent.element.removeChild(this.childrenRepeater[t].element);this.childrenRepeater.length>e.length&&(this.childrenRepeater.length=e.length)}else{var c=-1;for(var h in e){c++;var s,o=this.childrenRepeater[c];if(!o){var u=this.element.cloneNode(!0),f=j(u,this.scope._createChild(),!0);f.parent=this.parent,f.template=this.template,this.childrenRepeater[c]=f,M(this.repeater,f.scope,e[h]),f.scope[a.key]=h,R(this.template,u,this.parent,f),f.update(),f.render(),s?k(s,u):this.previousSibling?k(this.previousSibling,u):this.nextSibling?C(this.nextSibling,u):this.parent.element.appendChild(u),s=f.element}else M(this.repeater,o.scope,e[h]),o.scope[a.key]=h,o.update(),o.render(),s=o.element}var p=c;while(c++<this.childrenRepeater.length-1)this.parent.element.removeChild(this.childrenRepeater[c].element);this.childrenRepeater.length=p+1}this.element.parentNode&&this.element.parentNode.removeChild(this.element)}};var V=function(e,t,n,r){this.name=e,this.value=t,this.node=n,this.interpolationName=new $(this.name,null,this),this.interpolationValue=new $(this.value,null,this),this.invalidate=!1};V.prototype={toString:function(){return"[object Attribute]"},render:function(){function t(t,n){t=="class"?e.className=n:e.setAttribute(t,n)}function n(t,n){e.setAttribute("src",n)}function r(t,n){e.setAttribute("href",n)}if(this.node.repeater)return;var e=this.node.element;this.invalidate&&(this.invalidate=!1,this.name=this.interpolationName.render()||this.name,this.value=this.interpolationValue.render()||this.value,this.name===u.src?n(this.name,this.value):this.name===u.href?r(this.name,this.value):(this.node.element.removeAttribute(this.interpolationName.value),t(this.name,this.value))),this.name==="class"&&this.value.indexOf(s.attributes.cloak)!==-1&&L(this.node.element,s.attributes.cloak),this.name===u.hide&&(e.style.display=!m(this.value)||this.value===""||this.value===!0||this.value==="true"?"none":"block"),this.name===u.show&&(e.style.display=!m(this.value)||this.value===""||this.value===!0||this.value==="true"?"block":"none")}};var $=function(e,t,n){this.value=t&&!d(t.element)?x(e):e,this.node=t,this.attribute=n,this.sequence=[],this.expressions=[];var r=this.value.match(f.sequence);if(r){var i=-1,s=r.length;while(++i<s)if(r[i].match(f.token)){var o=new J(N(r[i]),this.node,this.attribute);this.sequence.push(o),this.expressions.push(o)}else this.sequence.push(r[i]);T(this.sequence)}};$.prototype={toString:function(){return"[object Interpolation]"},update:function(){var e=-1,t=this.expressions.length;while(++e<t)this.expressions[e].update()},render:function(){var e="";if(this.sequence){var t=-1,n=this.sequence.length;while(++t<n){var r="";g(this.sequence[t])?r=this.sequence[t].value:r=this.sequence[t],m(r)||(r=""),e+=r}}return e}};var J=function(e,t,n){if(!m(e))return;this.pattern=e,this.node=t,this.attribute=n,this.isFunction=b(this.pattern),this.path=P(this.pattern),this.accessor=H(this.pattern),this.params=this.isFunction?B(this.pattern.match(f.func)[2]):null,this.value,this.watchers=[]};J.prototype={toString:function(){return"[object Expression]"},update:function(){var e=this.node||this.attribute.node,t=this.getValue(e.scope);t=_(this,t),this.value!==t&&(this.value=t,(this.node||this.attribute).invalidate=!0)},getValue:function(e){return D(e,this.path,this.accessor,this.params,this.isFunction)}};var K=new A,Q=function(e){this.watchers=new A,this.node=null,this.scope=null,this.compile(e)};Q.prototype={toString:function(){return"[object Template]"},compile:function(e){e&&(this.element=e),this.node&&this.node.dispose(),this.node=R(this,this.element),this.node.root=!0,this.scope=this.node.scope},update:function(e){m(e)&&U(this.node.scope,e),this.node&&this.node.update()},render:function(e){this.update(e),this.node&&this.node.render()},invalidate:function(){this.node&&this.node.invalidateData()},watch:function(e,t){if(!h(e)&&!p(e)||!v(t))return;this.watchers.put(e,t)},unwatch:function(e){this.watchers.remove(e)},clearWatchers:function(){this.watchers.dispose()},getNode:function(e){return this.node.getNode(e)},dispose:function(){K.remove(this.element),this.watchers&&this.watchers.dispose(),this.node&&this.node.dispose(),this.element=null,this.watchers=null,this.node=null}},S(),e.template.create=G,e.template.get=Y,e.template.renderAll=Z})(this.soma=this.soma||{});