/*! soma-template - v0.0.1 - 2012-10-25
* http://www.soundstep.com/
* Copyright (c) 2012 Soundstep */
(function(e,t){"use strict";function b(e,t){return e.compareDocumentPosition?e.compareDocumentPosition(t):e.contains?(e!=t&&e.contains(t)&&16)+(e!=t&&t.contains(e)&&8)+(e.sourceIndex>=0&&t.sourceIndex>=0?(e.sourceIndex<t.sourceIndex&&4)+(e.sourceIndex>t.sourceIndex&&2):1)+0:0}var n=!1;e.template=e.source||{},e.template.version="0.0.1";var r=e.template.errors={COMPILE_NO_ELEMENT:"Error in soma.template, no target specified: template.source(element).compile(data).",REPEAT_WRONG_ARGUMENTS:"Error in soma.template, repeat attribute requires this syntax: 'item in items'."},i=e.template.settings=e.template.settings||{},s=i.tokens={start:"{{",end:"}}"},o=i.regex={attrs:new RegExp("([-A-Za-z0-9"+s.start+s.end+"(())._]+)(?:s*=s*(?:(?:\"((?:\\.|[^\"])*)\")|(?:'((?:\\.|[^'])*)')|([^> |	]+)))?","g"),pattern:new RegExp(s.start+"(.*?)"+s.end,"gm"),path:new RegExp(s.start+"|"+s.end,"gm"),node:/<(.|\n)*?>/gi,repeat:/(.*)\s+in\s+(.*)/,findFunction:/(.*)\((.*)\)/,findFunctionPath:/(.*)\.(.*)\(/,findParams:/,\s+|,|\s+,\s+/,findString:/('|")(.*)('|")/,findQuote:/\"|\'/g,findExtraQuote:/^["|']|["|']?$/g,findNotWhiteSpace:/[^\s]/gm},u=i.attributes={skip:"data-skip",repeat:"data-repeat",src:"data-src",href:"data-href",show:"data-show",hide:"data-hide"},a=i.vars={index:"index"},f=function(e){return Object.prototype.toString.apply(e)==="[object Array]"},l=function(e){return typeof e=="object"},c=function(e){return e?e.nodeType>0:!1},h=function(e,t){n&&console.log("----- GET PARAM VALUE",e,t);if(!e||e=="")return[];if(e.match(o.findString))return e=e.replace(o.findQuote,""),e.split(o.findParams);var r=[],i=e.split(o.findParams);for(var s=0;s<i.length;s++)n&&console.log(s,i[s],d(t,i[s])),r.push(d(t,i[s]));return r},p=function(e,r,i){n&&console.log("----- GET FUNCTION VALUE",e,r,i);var s=e.data,o,u,a;if(i[1].indexOf(".")===-1){o=i[1],u=h(i[2],e);if(!s[o])return e.parent?d(e.parent,r):t;a=s[o]}else{var f=i[1].split(".");o=f[f.length-1],u=h(i[2],e),f.pop(),n&&console.log("parts",f);var l=-1,c=f.length;while(++l<c){s=s[f[l]];if(!s)return e.parent?d(e.parent,r):t}a=s[o]}return typeof a=="function"?(n&&console.log("BEFORE CALL, fnCall: ",a),n&&console.log("BEFORE CALL, fp: ",u),n&&console.log("RESULT",a.apply(null,u)),a.apply(null,u)):(n&&console.log("fnCall",a),n&&console.log("val",s),n&&console.log("fn",o),n&&console.log("fp",u),t)},d=function(e,t){var r=t.match(o.findFunction);if(r)return p(e,t,r);n&&console.log("----- GET VALUE",e,t);var i=e.data,s=t.split("."),u=-1,a=s.length;while(++u<a){n&&console.log("PARTS",s,e,i),i=i[s[u]];if(!i&&e.parent){i=d(e.parent,t);break}}return n&&console.log("VAL",i),i},v=function(e,n,r,i){var s=r;return n===a.index&&e!==t?s.replace(i,e):s},m=function(e,t,n){var r=e,i=r.match(o.pattern);if(i){var s=-1,u=i.length;while(++s<u){var a=i[s].replace(o.path,""),f=v(n,a,r,i[s]);f=d(t,a),f&&(r=r.replace(i[s],f)),r=v(n,a,r,i[s])}}return r},g=function(e,t,n){e.nodeValue&&(e.nodeValue=m(e.nodeValue,t,n))},y=function(e,t){return e.contains?e!=t&&e.contains(t):!!(e.compareDocumentPosition(t)&16)},w=function(e,i,s){var c,h,p,v=!1;if(e.nodeType===8)return;if(e.nodeType===3&&!o.findNotWhiteSpace.test(e.nodeValue))return;if(e.getAttribute&&e.getAttribute(u.skip)!==null)return;var m=-1,y=x.length;console.log("-----------------------------",e),console.log(">>> compile target",T,b(T,e));while(++m<y){console.log("loop on",x[m].getTarget()),console.log("position ",e.compareDocumentPosition(x[m].getTarget()));if(b(e,T)>10&&b(e,x[m].getTarget())===0){console.log("ABORTED");return}}g(e,i,s);if(e.nodeType===3)return;n&&console.log("================== APPLY ==================",e,i,s);var E=e.outerHTML.match(o.node)[0],S=E.match(o.attrs);S.shift();if(S.length>0)for(var N=0;N<S.length;N++){var C=S[N].split("="),k=C[0],L=C[1].replace(o.findExtraQuote,"");if(k==="data-repeat"){c=L.match(o.repeat);if(!c||c.length!==3)throw new Error(r.REPEAT_WRONG_ARGUMENTS);var A=c[1],O=c[2],M=d(i,O);if(f(M)){v=!0,e.removeAttribute(u.repeat);var _=document.createDocumentFragment(),D,P=-1,H=M.length;while(++P<H){var B={};B[A]=M[P];var j=i.add(B,i);n&&console.log("childObj",j),D=e.cloneNode(!0),_.appendChild(D),w(D,j,P)}e.parentNode.appendChild(_),e.parentNode.removeChild(e)}else if(l(M)){v=!0,e.removeAttribute(u.repeat);var F=document.createDocumentFragment(),D;for(var I in M){n&&console.log(I,A,M);var q={};q[A]=M;var R=i.add(q,i);n&&console.log("childObj",R),D=e.cloneNode(!0),F.appendChild(D),w(D,R)}e.parentNode.appendChild(F),e.parentNode.removeChild(e)}}else if(k===u.src){c=L.match(o.pattern);if(c){var U=-1,z=c.length;while(++U<z){var h=c[U].replace(o.path,""),p=d(i,h);p&&(L=L.replace(c[U],p)),h===a.index&&s!==t&&(L=L.replace(c[U],s))}e.setAttribute("src",L),e.removeAttribute(u.src)}}else if(k===u.href){c=L.match(o.pattern);if(c){var W=-1,X=c.length;while(++W<X){var h=c[W].replace(o.path,""),p=d(i,h);p&&(L=L.replace(c[W],p)),h===a.index&&s!==t&&(L=L.replace(c[W],s))}e.setAttribute("href",L),e.removeAttribute(u.href)}}else if(k===u.show){c=L.match(o.pattern);if(c){var V=-1,$=c.length;while(++V<$){var h=c[V].replace(o.path,""),p=d(i,h);p&&(e.style.display="block")}e.removeAttribute(u.show)}}else if(k===u.hide){c=L.match(o.pattern);if(c){var J=-1,K=c.length;while(++J<K){var h=c[J].replace(o.path,""),p=d(i,h);p&&(e.style.display="none")}e.removeAttribute(u.hide)}}else{c=k.match(o.pattern);if(c){var Q=-1,G=c.length;while(++Q<G){var h=c[Q].replace(o.path,""),p=d(i,h);p&&(k=k.replace(c[Q],p)),e.setAttribute(k,p),e.removeAttribute(c[Q])}}if(L){c=L.match(o.pattern);if(c){var Y=-1,Z=c.length;while(++Y<Z){var h=c[Y].replace(o.path,"");if(h===a.index&&s!==t)L=L.replace(c[Y],s);else{var p=d(i,h);p!==t?L=L.replace(c[Y],p):L=L.replace(c[Y],"")}}k==="class"&&e.className?e.className=L:e.setAttribute(k,L)}}}}var E=e.firstChild;while(E){if(v)return;w(E,i,s),E=E.nextSibling}},E=function(){function t(e,n){var r={parent:n,data:e,children:[],add:t};return n&&n.children.push(r),r}var e={};return{create:function(n,r){return e={parent:r,data:n,children:[],add:t},e}}},S=function(e){function o(e){t=e,n=c(t)?t.innerHTML:t}var t,n,i,s=new E;return e&&o(e),{source:function(e){o(e)},setTarget:function(e){return i=e,this},getTarget:function(){return i},compile:function(e){if(!i){if(!c(t))throw new Error(r.COMPILE_NO_ELEMENT);i=t}return i.innerHTML=n,T=i,w(i,s.create(e)),this},dispose:function(){return t=null,n=null,i=null,this}}},x=[],T;e.template.disposeAll=function(){x.length=0},e.template.dispose=function(e){var t=-1,n=x.length;while(++t<n)if(x[t]===e){x.splice(t,1);break}},e.template.create=function(e){var t=new S(e);return x.push(t),t},typeof define=="function"&&define.amd&&define("soma-template",e),typeof exports!="undefined"&&(typeof module!="undefined"&&module.exports&&(exports=module.exports=e),exports=e)})(this.soma=this.soma||{});