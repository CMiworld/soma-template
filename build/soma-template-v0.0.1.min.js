/*! soma-template - v0.0.1 - 2012-10-23
* http://www.soundstep.com/
* Copyright (c) 2012 Soundstep */
(function(e,t){"use strict";e.template=e.source||{},e.template.version="0.0.1";var n=e.template.errors={COMPILE_NO_ELEMENT:"Error in soma.Template.compile(), no target specified: template.source(element).compile(data).",REPEAT_WRONG_ARGUMENTS:"Error in template, repeat attribute requires this syntax: 'item in items'."},r=e.template.settings=e.template.settings||{},i=r.tokens={start:"{{",end:"}}"},s=r.regex={attrs:new RegExp("([-A-Za-z0-9"+i.start+i.end+"(())._]+)(?:s*=s*(?:(?:\"((?:\\.|[^\"])*)\")|(?:'((?:\\.|[^'])*)')|([^> |	]+)))?","g"),pattern:new RegExp(i.start+"(.*?)"+i.end,"gm"),path:new RegExp(i.start+"|"+i.end,"gm"),node:/<(.|\n)*?>/gi,repeat:/(.*)\s+in\s+(.*)/,findFunction:/(.*)\((.*)\)/,findParams:/,\s+|,|\s+,\s+/,findString:/('|")(.*)('|")/,findDoubleQuote:/\"/g,findSingleQuote:/\'/g},o=r.attrs={skip:"data-skip"},u=r.vars={index:"index"},a=function(e){return Object.prototype.toString.apply(e)==="[object Array]"},f=function(e){return typeof e=="object"},l=function(e){return e?e.nodeType>0:!1},c=function(e,n){var r=n.match(s.findFunction),i;r?(i=r[1].split("."),i[1]+="("+r[2]+")"):i=n.split(".");var n=e,o=-1,u=i.length;while(++o<u){var a=i[o].match(s.findFunction);if(a){var f=a[1],l=a[2],h=[];if(typeof n[f]!="function")return t;if(l&&l!=="")if(l.match(s.findString))l=l.replace(s.findDoubleQuote,""),l=l.replace(s.findSingleQuote,""),h=l.split(s.findParams);else{var p=l.split(s.findParams);for(var d=0;d<p.length;d++)h.push(c(e,p[d]))}var v=n[f].apply(null,h);return v?v:t}if(!n[i[o]])return t;n=n[i[o]]}return n},h=function(e,n,r,i){var s=r;return n===u.index&&e!==t?s.replace(i,e):s},p=function(e,t,n){var r=e,i=r.match(s.pattern);if(i){var o=-1,u=i.length;while(++o<u){var a=i[o].replace(s.path,""),f=c(t,a);f&&(r=r.replace(i[o],f)),r=h(n,a,r,i[o])}}return r},d=function(e,t,n){e.nodeValue&&(e.nodeValue=p(e.nodeValue,t,n))},v=function(e,r,i){var u,l,h,p=!1;if(e.nodeType===8)return;if(e.getAttribute&&e.getAttribute(o.skip)!==null)return;d(e,r,i);if(e.nodeType===3)return;var m=e.outerHTML.match(s.node)[0],g=m.match(s.attrs);g.shift();if(g.length>0)for(var y=0;y<g.length;y++){var b=g[y].split("="),w=b[0],E=b[1];E&&(E=E.replace(s.findDoubleQuote,""),E=E.replace(s.findSingleQuote,""));if(w==="data-repeat"){u=E.match(s.repeat);if(!u||u.length!==3)throw new Error(n.REPEAT_WRONG_ARGUMENTS);var S=u[1],x=u[2],T=c(r,x);if(a(T)){p=!0,e.removeAttribute("data-repeat");var N=document.createDocumentFragment(),C={},k,L=-1,A=T.length;while(++L<A)C[S]=T[L],k=e.cloneNode(!0),N.appendChild(k),v(k,C,L);e.parentNode.appendChild(N),e.parentNode.removeChild(e)}else if(f(T)){p=!0,e.removeAttribute("data-repeat");var O=document.createDocumentFragment(),M={},k;for(var _ in T)M[S]=T,k=e.cloneNode(!0),O.appendChild(k),v(k,M);e.parentNode.appendChild(O),e.parentNode.removeChild(e)}}else if(w==="data-src"){u=E.match(s.pattern);if(u){var D=-1,P=u.length;while(++D<P){var l=u[D].replace(s.path,""),h=c(r,l);h&&(E=E.replace(u[D],h)),l==="index"&&i!==t&&(E=E.replace(u[D],i))}e.setAttribute("src",E),e.removeAttribute("data-src")}}else if(w==="data-href"){u=E.match(s.pattern);if(u){var H=-1,B=u.length;while(++H<B){var l=u[H].replace(s.path,""),h=c(r,l);h&&(E=E.replace(u[H],h)),l==="index"&&i!==t&&(E=E.replace(u[H],i))}e.setAttribute("href",E),e.removeAttribute("data-href")}}else if(w==="data-show"){u=E.match(s.pattern);if(u){var j=-1,F=u.length;while(++j<F){var l=u[j].replace(s.path,""),h=c(r,l);h&&(e.style.display="block")}e.removeAttribute("data-show")}}else if(w==="data-hide"){u=E.match(s.pattern);if(u){var I=-1,q=u.length;while(++I<q){var l=u[I].replace(s.path,""),h=c(r,l);h&&(e.style.display="none")}e.removeAttribute("data-hide")}}else{u=w.match(s.pattern);if(u){var R=-1,U=u.length;while(++R<U){var l=u[R].replace(s.path,""),h=c(r,l);h&&(w=w.replace(u[R],h)),e.setAttribute(w,h),e.removeAttribute(u[R])}}if(E){u=E.match(s.pattern);if(u){var z=-1,W=u.length;while(++z<W){var l=u[z].replace(s.path,"");if(l==="index"&&i!==t)E=E.replace(u[z],i);else{var h=c(r,l);h!==t?E=E.replace(u[z],h):E=E.replace(u[z],"")}}w==="class"&&e.className?e.className=E:e.setAttribute(w,E)}}}}var m=e.firstChild;while(m){if(p)return;v(m,r,i),m=m.nextSibling}};e.Template=function(e){function s(e){t=e,r=l(t)?t.innerHTML:t}var t,r,i;return e&&s(e),{source:function(e){s(e)},target:function(e){return i=e,this},compile:function(e){if(!i){if(!l(t))throw new Error(n.COMPILE_NO_ELEMENT);i=t}return i.innerHTML=r,v(i,e),this},dispose:function(){return t=null,r=null,i=null,this}}},typeof define=="function"&&define.amd&&define("soma-template",e),typeof exports!="undefined"&&(typeof module!="undefined"&&module.exports&&(exports=module.exports=e),exports=e)})(this.soma=this.soma||{});