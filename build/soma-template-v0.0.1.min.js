/*! soma-template - v0.0.1 - 2012-10-23
* http://www.soundstep.com/
* Copyright (c) 2012 Soundstep */
(function(e,t){"use strict";e.template=e.source||{},e.template.version="0.0.1";var n=e.template.errors={COMPILE_NO_ELEMENT:"Error in soma.Template.compile(), no target specified: template.source(element).compile(data).",REPEAT_WRONG_ARGUMENTS:"Error in template, repeat attribute requires this syntax: 'item in items'."},r=e.template.settings=e.template.settings||{},i=r.tokens={start:"{{",end:"}}"},s=r.regex={pattern:new RegExp(i.start+"(.*?)"+i.end,"gm"),path:new RegExp(i.start+"|"+i.end,"gm"),repeat:/(.*)\s+in\s+(.*)/,findFunction:/(.*)\((.*)\)/,findParams:/,\s+|,|\s+,\s+/,findString:/('|")(.*)('|")/,findDoubleQuote:/\"/g,findSingleQuote:/\'/g},o=r.attrs={skip:"data-skip"},u=r.vars={index:"index"},a=function(e){return toString.apply(e)==="[object Array]"},f=function(e){return typeof e=="object"},l=function(e){return e?e.nodeType>0:!1},c=function(e,n){var r=n.match(s.findFunction),i;r?(i=r[1].split("."),i[1]+="("+r[2]+")"):i=n.split(".");var n=e;for(var o=0;o<i.length;o++){var u=i[o].match(s.findFunction);if(u){var a=u[1],f=u[2];if(typeof n[a]!="function")return t;if(f&&f!==""){var l=[];if(f.match(s.findString))f=f.replace(s.findDoubleQuote,""),f=f.replace(s.findSingleQuote,""),l=f.split(s.findParams);else{var h=f.split(s.findParams);for(var p=0;p<h.length;p++)l.push(c(e,h[p]))}}var d=n[a].apply(this,l);return d?d:t}if(!n[i[o]])return t;n=n[i[o]]}return n},h=function(e,n,r,i){var s=r;return n===u.index&&e!==t?s.replace(i,e):s},p=function(e,t,n){var r=e,i=r.match(s.pattern);if(i)for(var o=0;o<i.length;o++){var u=i[o].replace(s.path,""),a=c(t,u);a&&(r=r.replace(i[o],a)),r=h(n,u,r,i[o])}return r},d=function(e,t,n){e.nodeValue&&(e.nodeValue=p(e.nodeValue,t,n))},v=function(e,r,i){var u,l,h;if(e.nodeName==="#comment")return;if(e.getAttribute&&e.getAttribute(o.skip)!==null)return;d(e,r,i);if(e.attributes)for(var p,m=0,g=e.attributes,y=g.length;m<y;m++){p=g.item(m);var b=p.nodeName,w=p.nodeValue;if(b==="data-repeat"){u=w.match(s.repeat);if(!u||u.length!==3)throw new Error(n.REPEAT_WRONG_ARGUMENTS);var E=u[1],S=u[2],x=c(r,S);if(a(x)){for(var T=0;T<x.length;T++){var N={};N[E]=x[T];var C=e.cloneNode(!0);C.removeAttribute("data-repeat"),e.parentNode.appendChild(C),v(C,N,T)}e.parentNode.removeChild(e)}else if(f(x)){for(var k in x){var L={};L[E]=x;var C=e.cloneNode(!0);C.removeAttribute("data-repeat"),e.parentNode.appendChild(C),v(C,L)}e.parentNode.removeChild(e)}}else if(b==="data-src"){u=w.match(s.pattern);if(u){for(var m=0;m<u.length;m++){var l=u[m].replace(s.path,""),h=c(r,l);h&&(w=w.replace(u[m],h)),l==="index"&&i!==t&&(w=w.replace(u[m],i))}e.setAttribute("src",w),e.removeAttribute("data-src")}}else if(b==="data-href"){u=w.match(s.pattern);if(u){for(var m=0;m<u.length;m++){var l=u[m].replace(s.path,""),h=c(r,l);h&&(w=w.replace(u[m],h)),l==="index"&&i!==t&&(w=w.replace(u[m],i))}e.setAttribute("href",w),e.removeAttribute("data-href")}}else if(b==="data-show"){u=w.match(s.pattern);if(u){for(var m=0;m<u.length;m++){var l=u[m].replace(s.path,""),h=c(r,l);h&&(e.style.display="block")}e.removeAttribute("data-show")}}else if(b==="data-hide"){u=w.match(s.pattern);if(u){for(var m=0;m<u.length;m++){var l=u[m].replace(s.path,""),h=c(r,l);h&&(e.style.display="none")}e.removeAttribute("data-hide")}}else{u=b.match(s.pattern);if(u)for(var m=0;m<u.length;m++){var l=u[m].replace(s.path,""),h=c(r,l);h&&(b=b.replace(u[m],h)),e.removeAttribute(u[m])}u=w.match(s.pattern);if(u)for(var m=0;m<u.length;m++){var l=u[m].replace(s.path,"");if(l==="index"&&i!==t)w=w.replace(u[m],i);else{var h=c(r,l);h!==t?w=w.replace(u[m],h):w=w.replace(u[m],"")}}e.setAttribute(b,w)}}if(e.childNodes.length>0){if(e.getAttribute&&e.getAttribute("data-repeat"))return;for(var m=0;m<e.childNodes.length;m++){var A=e.childNodes[m];v(A,r,i)}}};e.Template=function(e){function s(e){t=e,r=l(t)?t.innerHTML:t}var t,r,i;return e&&s(e),{source:function(e){s(e)},target:function(e){return i=e,this},compile:function(e){if(!i){if(!l(t))throw new Error(n.COMPILE_NO_ELEMENT);i=t}return i.innerHTML=r,v(i,e),this},dispose:function(){return t=null,r=null,i=null,this}}},typeof define=="function"&&define.amd&&define("soma-template",e),typeof exports!="undefined"&&(typeof module!="undefined"&&module.exports&&(exports=module.exports=e),exports=e)})(this.soma=this.soma||{});