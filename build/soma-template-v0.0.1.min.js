/*! soma-template - v0.0.1 - 2012-11-15
* http://www.soundstep.com/
* Copyright (c) 2012 Soundstep */
(function(e,t){"use strict";function h(e){return Object.prototype.toString.apply(e)==="[object Array]"}function p(e){return typeof e=="object"}function d(e){return typeof e=="string"}function v(e){return e?e.nodeType>0:!1}function m(e){return e&&e.nodeType&&e.nodeType===3}function g(e){return e&&typeof e=="function"}function y(e){return e!==null&&e!==t}function b(e){return e===""||e===!0||e==="true"||!y(e)}function w(e){return e&&g(e.toString)&&e.toString()==="[object Expression]"}function E(e){return e&&g(e.toString)&&e.toString()==="[object Node]"}function S(e){return d(e)?!!e.match(c.func):!1}function x(e){return!e||!v(e.element)?!1:e.parent&&ut.get(e.element)?!0:!1}function T(e){return e.replace(c.escape,"\\$&")}function N(e,t){var n=a.start().replace(/\\/g,""),r="",i=t?e:n;i.length>1&&(r="|\\"+i.substr(0,1)+"(?!\\"+i.substr(1,1)+")[^"+i.substr(0,1)+"]*"),c.sequence=new RegExp(a.start()+".+?"+a.end()+"|[^"+a.start()+"]+"+r,"g"),c.token=new RegExp(a.start()+".*?"+a.end(),"g"),c.expression=new RegExp(a.start()+"|"+a.end(),"gm")}function C(e){return e.replace(c.trim,"")}function k(e){return c.string.test(e)?e.substr(1,e.length-2):e}function L(e){return e[0]===""&&e.shift(),e[e.length-1]===""&&e.pop(),e}function A(e){return e.replace(c.expression,"")}function O(e){return e.replace(c.depth,"")}function M(e,t){if(!e.parentNode)return;e.parentNode.insertBefore(t,e)}function _(e,t){if(!e.parentNode)return;e.parentNode.insertBefore(t,e.nextSibling)}function D(e,t){document.documentElement.classList?D=function(e,t){e.classList.remove(t)}:D=function(e,t){if(!e||!e.className)return!1;var n=new RegExp("(^|\\s)"+t+"(\\s|$)","g");e.className=e.className.replace(n,"$2")},D(e,t)}function P(){var e=function(e,t){for(t=e="";e++<36;t+=e*51&52?(e^15?8^Math.random()*(e^20?16:4):4).toString(16):"-");return t},t={},n=function(t){if(!t)return;if(typeof t!="object")return t;var n;try{n=t.hashkey?t.hashkey:t.hashkey=e()}catch(r){}return n};return{put:function(e,r){t[n(e)]=r},get:function(e){return t[n(e)]},remove:function(e){delete t[n(e)]},getData:function(){return t},dispose:function(){for(var e in t)t[e]=null,delete t[e]}}}function H(e,t){var n=e.match(c.repeat);if(!n)return;var r=n[2],i=new ot(r);return i.getValue(t)}function B(e,t,n){var r=e.match(c.repeat);if(!r)return;var i=r[1];t[i]=n}function j(e,t){var n=e.node||e.attribute.node,r=n.template.watchers,i=n.element;if(!r)return t;var s=r.get(i);!s&&m(n.element)&&n.parent&&(s=r.get(n.parent.element));var o=s?s:r.get(e.pattern);if(g(o)){var u=o(e.value,t,e.pattern,n.scope,n,e.attribute);if(y(u))return u}return t}function F(e,t){var n=W(t),r=e;while(n>0)r=r._parent?r._parent:r,n--;return r}function I(e,t){var n=new ot(t);return q(e,n.pattern,n.path,n.accessor,n.params,n.isFunction)}function q(e,n,r,i,s,o,u){if(c.string.test(n))return k(n);var a=[];if(!u&&s){var f=-1,l=s.length;while(++f<l)a.push(I(e,s[f]))}else a=u;var h=F(e,n);n=n.replace("../","");if(!h)return t;var p=r.split("."),d=h;if(p[0]!==""){var v=-1,m=p.length;while(++v<m){d=d[p[v]];if(!d)return h._parent?q(h._parent,n,r,i,s,o,a):t}}return o?y(d[i])?g(d[i])?d[i].apply(null,a):h._parent?q(h._parent,n,r,i,s,o,a):t:h._parent?q(h._parent,n,r,i,s,o,a):t:!y(d[i])&&h._parent?q(h._parent,n,r,i,s,o,a):d[i]}function R(e){var t=e.split("(")[0];return t=O(t),t.substr(0,t.lastIndexOf("."))}function U(e){var t=e.split("(")[0];return t=O(t),t.substring(t.lastIndexOf(".")).replace(".","")}function z(e){return L(e.split(c.params))}function W(e){var t=e.split("(")[0],n=t.match(c.depth);return n?n.length:0}function X(e,t,n){var r=new rt(e,t);r.previousSibling=e.previousSibling,r.nextSibling=e.nextSibling;var i=[];for(var s,o,a,f=e.attributes,l=0,c=f&&f.length;l<c;l++)s=f[l],s.specified&&(o=s.name,a=s.value,o===u.attributes.skip&&(r.skip=a===""||a==="true"),!n&&o===u.attributes.repeat&&(r.repeater=a),(V(o+":"+a)||o===u.attributes.repeat||o===u.attributes.show||o===u.attributes.hide||o===u.attributes.href||o===u.attributes.checked||o===u.attributes.disabled||o===u.attributes.multiple||o===u.attributes.readonly||o===u.attributes.selected||a.indexOf(u.attributes.cloak)!==-1)&&i.push(new it(o,a,r)));return r.attributes=i,r}function V(e){var t=e.match(c.token);return t&&t.length>0}function $(e){return c.content.test(e)}function J(e){if(!e)return;var t=e.nodeType;return!e||!t?!1:t===8?!1:t===3&&!$(e.nodeValue)&&!V(e.nodeValue)?!1:!0}function K(e,t,n,r){if(!J(t))return;var i;r?(i=r,i.parent=n):i=X(t,n?n.scope:(new nt(o))._createChild()),i.template=e;if(i.skip)return;var s=t.firstChild;while(s){var u=K(e,s,i);u&&(u.parent=i,i.children.push(u)),s=s.nextSibling}return i}function Q(e,t){G(e);for(var n in t)e[n]=t[n]}function G(e){for(var t in e)t.substr(0,1)!=="_"&&(e[t]=null,delete e[t])}function Y(e){if(x(e)||e.repeater||!e.children)return;var t=-1,n=e.children.length;while(++t<n)e.children[t].update()}function Z(e){if(x(e)||!e.children)return;var t=-1,n=e.children.length;while(++t<n)e.children[t].render()}function et(e){var t=H(e.repeater,e.scope),n;if(h(t)){var r=-1,i=t.length,s=e.childrenRepeater.length,o=i>s?i:s;while(++r<o)r<i?n=tt(e,r,t[r],l.index,r,n):e.parent.element.removeChild(e.childrenRepeater[r].element);e.childrenRepeater.length>t.length&&(e.childrenRepeater.length=t.length)}else{var u=-1;for(var a in t)u++,n=tt(e,u,t[a],l.key,a,n);var f=u;while(u++<e.childrenRepeater.length-1)e.parent.element.removeChild(e.childrenRepeater[u].element);e.childrenRepeater.length=f+1}e.element.parentNode&&e.element.parentNode.removeChild(e.element)}function tt(e,t,n,r,i,s){var o=e.childrenRepeater[t];if(!o){var u=e.element.cloneNode(!0),a=X(u,e.scope._createChild(),!0);return a.parent=e.parent,a.template=e.template,e.childrenRepeater[t]=a,B(e.repeater,a.scope,n),a.scope[r]=i,K(e.template,u,e.parent,a),a.update(),a.render(),s?_(s,u):e.previousSibling?_(e.previousSibling,u):e.nextSibling?M(e.nextSibling,u):e.parent.element.appendChild(u),u}return B(e.repeater,o.scope,n),o.scope[r]=i,o.update(),o.render(),o.element}function ft(t,n){var r;if(d(t)){if(!v(n))throw new Error(e.template.errors.TEMPLATE_STRING_NO_ELEMENT);n.innerHTML=t,r=n}else{if(!v(t))throw new Error(e.template.errors.TEMPLATE_NO_PARAM);v(n)?(n.innerHTML=t.innerHTML,r=n):r=t}lt(r)&&(lt(r).dispose(),ut.remove(r));var i=new at(r);return ut.put(r,i),i}function lt(e){return v(e)?ut.get(e):null}function ct(){for(var e in ut.getData())ut.get(e).render()}function ht(e){e===null&&(s={},o={});if(y(e)&&p(e))for(var t in e)e.hasOwnProperty(t)&&(s[t]=o[t]=e[t]);return s}e.template=e.source||{},e.template.version="0.0.1";var n=e.template.errors={TEMPLATE_STRING_NO_ELEMENT:"Error in soma.template, a string template requirement a second parameter: an element target - soma.template.create('string', element)",TEMPLATE_NO_PARAM:"Error in soma.template, a template requires at least 1 parameter - soma.template.create(element)",REPEAT_WRONG_ARGUMENTS:"Error in soma.template, repeat attribute requires this syntax: 'item in items'."},r="{{",i="}}",s={},o={},u=e.template.settings=e.template.settings||{},a=u.tokens={start:function(e){return y(e)&&e!==""&&(r=T(e),N(e,!0)),r},end:function(e){return y(e)&&e!==""&&(i=T(e),N(e,!1)),i}},f=u.attributes={skip:"data-skip",repeat:"data-repeat",src:"data-src",href:"data-href",show:"data-show",hide:"data-hide",cloak:"data-cloak",checked:"data-checked",disabled:"data-disabled",multiple:"data-multiple",readonly:"data-readonly",selected:"data-selected"},l=u.vars={index:"$index",key:"$key"},c={sequence:null,token:null,expression:null,escape:/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,trim:/^[\s+]+|[\s+]+$/g,repeat:/(.*)\s+in\s+(.*)/,func:/(.*)\((.*)\)/,params:/,\s+|,|\s+,\s+/,quote:/\"|\'/g,content:/[^.|^\s]/gm,depth:/..\//g,string:/^(\"|\')(.*)(\"|\')$/},nt=function(e){function t(e){var t=n(e);return t._parent=this,this._children.push(t),t}function n(e){var n=e||{};return n._parent=null,n._children=[],n._createChild=function(e){return t.apply(n,arguments)},n}return n(e)},rt=function(e,t){this.element=e,this.scope=t,this.attributes=null,this.value=null,this.interpolation=null,this.invalidate=!1,this.skip=!1,this.repeater=null,this.parent=null,this.children=[],this.childrenRepeater=[],this.previousSibling=null,this.nextSibling=null,this.template=null,m(this.element)&&(this.value=this.element.nodeValue,this.interpolation=new st(this.value,this))};rt.prototype={toString:function(){return"[object Node]"},dispose:function(){var e,t;if(this.children){e=-1,t=this.children.length;while(++e<t)this.children[e].dispose()}if(this.childrenRepeater){e=0,t=this.childrenRepeater.length;while(++e<t)this.childrenRepeater[e].dispose()}if(this.attributes){e=0,t=this.attributes.length;while(++e<t)this.attributes[e].dispose()}this.interpolation&&this.interpolation.dispose(),this.element=null,this.scope=null,this.attributes=null,this.value=null,this.interpolation=null,this.repeater=null,this.parent=null,this.children=null,this.childrenRepeater=null,this.previousSibling=null,this.nextSibling=null,this.template=null},getNode:function(e){var t;if(e===this.element)return this;if(this.childrenRepeater.length>0){var n=-1,r=this.childrenRepeater.length;while(++n<r){t=this.childrenRepeater[n].getNode(e);if(t)return t}}else{var i=-1,s=this.children.length;while(++i<s){t=this.children[i].getNode(e);if(t)return t}}return null},update:function(){if(x(this))return;y(this.interpolation)&&this.interpolation.update();if(y(this.attributes)){var e=-1,t=this.attributes.length;while(++e<t)this.attributes[e].update()}Y(this)},invalidateData:function(){if(x(this))return;this.invalidate=!0;var e,t;if(this.attributes){e=-1,t=this.attributes.length;while(++e<t)this.attributes[e].invalidate=!0}e=-1,t=this.childrenRepeater.length;while(++e<t)this.childrenRepeater[e].invalidateData();e=-1,t=this.children.length;while(++e<t)this.children[e].invalidateData()},render:function(){if(x(this))return;this.invalidate&&(this.invalidate=!1,m(this.element)&&(this.value=this.element.nodeValue=this.interpolation.render()));if(this.attributes){var e=-1,t=this.attributes.length;while(++e<t)this.attributes[e].render()}this.repeater?et(this):Z(this)}};var it=function(e,t,n,r){this.name=e,this.value=t,this.node=n,this.interpolationName=new st(this.name,null,this),this.interpolationValue=new st(this.value,null,this),this.invalidate=!1};it.prototype={toString:function(){return"[object Attribute]"},dispose:function(){this.interpolationName&&this.interpolationName.dispose(),this.interpolationValue&&this.interpolationValue.dispose(),this.interpolationName=null,this.interpolationValue=null,this.node=null,this.name=null,this.value=null,this.previousName=null},update:function(){this.interpolationName.update(),this.interpolationValue.update()},render:function(){function t(t,n){t=="class"?e.className=n:e.setAttribute(t,n)}function n(t,n,r){b(n)?e.setAttribute(r,r):e.removeAttribute(r)}function r(t,n){e.setAttribute("src",n)}function i(t,n){e.setAttribute("href",n)}if(this.node.repeater)return;var e=this.node.element;this.invalidate&&(this.invalidate=!1,this.previousName=this.name,this.name=this.interpolationName.render()||this.name,this.value=this.interpolationValue.render()||this.value,this.name===f.src?r(this.name,this.value):this.name===f.href?i(this.name,this.value):(this.node.element.removeAttribute(this.interpolationName.value),this.previousName&&this.node.element.removeAttribute(this.previousName),t(this.name,this.value,this.previousName))),this.name==="class"&&this.value.indexOf(u.attributes.cloak)!==-1&&D(this.node.element,u.attributes.cloak),this.name===f.hide&&(e.style.display=b(this.value)?"none":"block"),this.name===f.show&&(e.style.display=b(this.value)?"block":"none"),this.name===f.checked&&n(this.name,this.value,"checked"),this.name===f.disabled&&n(this.name,this.value,"disabled"),this.name===f.multiple&&n(this.name,this.value,"multiple"),this.name===f.readonly&&n(this.name,this.value,"readonly"),this.name===f.selected&&n(this.name,this.value,"selected")}};var st=function(e,t,n){this.value=t&&!m(t.element)?C(e):e,this.node=t,this.attribute=n,this.sequence=[],this.expressions=[];var r=this.value.match(c.sequence);if(r){var i=-1,s=r.length;while(++i<s)if(r[i].match(c.token)){var o=new ot(A(r[i]),this.node,this.attribute);this.sequence.push(o),this.expressions.push(o)}else this.sequence.push(r[i]);L(this.sequence)}};st.prototype={toString:function(){return"[object Interpolation]"},dispose:function(){if(this.expressions){var e=-1,t=this.expressions.length;while(++e<t)this.expressions[e].dispose()}this.value=null,this.node=null,this.attribute=null,this.sequence=null,this.expressions=null},update:function(){var e=-1,t=this.expressions.length;while(++e<t)this.expressions[e].update()},render:function(){var e="";if(this.sequence){var t=-1,n=this.sequence.length;while(++t<n){var r="";w(this.sequence[t])?r=this.sequence[t].value:r=this.sequence[t],y(r)||(r=""),e+=r}}return e}};var ot=function(e,n,r){if(!y(e))return;this.pattern=e,this.isString=c.string.test(e),this.node=n,this.attribute=r,this.value=this.isString?this.pattern:t,this.isString?(this.isFunction=!1,this.depth=null,this.path=null,this.accessor=null,this.params=null):(this.isFunction=S(this.pattern),this.depth=W(this.pattern),this.path=R(this.pattern),this.accessor=U(this.pattern),this.params=this.isFunction?z(this.pattern.match(c.func)[2]):null)};ot.prototype={toString:function(){return"[object Expression]"},dispose:function(){this.pattern=null,this.node=null,this.attribute=null,this.path=null,this.accessor=null,this.params=null,this.value=null},update:function(){var e=this.node;!e&&this.attribute&&(e=this.attribute.node);if(!e&&e.scope)return;var t=this.getValue(e.scope);t=j(this,t),this.value!==t&&(this.value=t,(this.node||this.attribute).invalidate=!0)},getValue:function(e){return q(e,this.pattern,this.path,this.accessor,this.params,this.isFunction)}};var ut=new P,at=function(e){this.watchers=new P,this.node=null,this.scope=null,this.compile(e)};at.prototype={toString:function(){return"[object Template]"},compile:function(e){e&&(this.element=e),this.node&&this.node.dispose(),this.node=K(this,this.element),this.node.root=!0,this.scope=this.node.scope},update:function(e){y(e)&&Q(this.node.scope,e),this.node&&this.node.update()},render:function(e){this.update(e),this.node&&this.node.render()},invalidate:function(){this.node&&this.node.invalidateData()},watch:function(e,t){if(!d(e)&&!v(e)||!g(t))return;this.watchers.put(e,t)},unwatch:function(e){this.watchers.remove(e)},clearWatchers:function(){this.watchers.dispose()},getNode:function(e){return this.node.getNode(e)},dispose:function(){ut.remove(this.element),this.watchers&&this.watchers.dispose(),this.node&&this.node.dispose(),this.element=null,this.watchers=null,this.node=null}},a.start(r),a.end(i),e.template.create=ft,e.template.get=lt,e.template.renderAll=ct,e.template.helpers=ht,typeof define=="function"&&define.amd&&define("soma-template",e.template),typeof exports!="undefined"&&(typeof module!="undefined"&&module.exports&&(exports=module.exports=e.template),exports=e.template)})(this.soma=this.soma||{});