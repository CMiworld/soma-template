/*! soma-template - v0.0.1 - 2012-11-03
* http://www.soundstep.com/
* Copyright (c) 2012 Soundstep */
(function(e,t){"use strict";function a(e){return Object.prototype.toString.apply(e)==="[object Array]"}function f(e){return typeof e=="object"}function l(e){return typeof e=="string"}function c(e){return e?e.nodeType>0:!1}function h(e){return e&&e.nodeType&&e.nodeType===3}function p(e){return e&&typeof e=="function"}function d(e){return e!==null&&e!==t}function v(e){return e&&p(e.toString)&&e.toString()==="[object Expression]"}function m(e){return e&&p(e.toString)&&e.toString()==="[object Node]"}function g(e){return toString.apply(e)==="[object Date]"}function y(e){return!!e.match(s.func)}function b(e){return!e||!c(e.element)?!1:e.parent&&J.get(e.element)?!0:!1}function w(e){return e.replace(s.escape,"\\$&")}function E(e){return e.replace(s.trim,"")}function S(e){return e[0]===""&&e.shift(),e[e.length-1]===""&&e.pop(),e}function x(e){return e.replace(s.expression,"")}function T(e,t){if(!e.parentNode)return;e.parentNode.insertBefore(t,e)}function N(e,t){if(!e.parentNode)return;e.parentNode.insertBefore(t,e.nextSibling)}function C(e,t){document.documentElement.classList?C=function(e,t){e.classList.remove(t)}:C=function(e,t){if(!e||!e.className)return!1;var n=new RegExp("(^|\\s)"+t+"(\\s|$)","g");e.className=e.className.replace(n,"$2")},C(e,t)}function k(e,t){if(e===t)return!0;if(e===null||t===null)return!1;if(e!==e&&t!==t)return!0;var n=typeof e,r=typeof t,i,s,o;if(n==r&&n=="object"){if(!a(e)){if(g(e))return g(t)&&e.getTime()==t.getTime();o={};for(s in e){if(!p(e[s])&&!k(e[s],t[s]))return!1;o[s]=!0}for(s in t)if(!o[s]&&s.charAt(0)!=="$"&&!p(t[s]))return!1;return!0}if((i=e.length)==t.length){for(s=0;s<i;s++)if(!k(e[s],t[s]))return!1;return!0}}return!1}function L(){var e=function(e,t){for(t=e="";e++<36;t+=e*51&52?(e^15?8^Math.random()*(e^20?16:4):4).toString(16):"-");return t},t={},n=function(t){if(!t)return;if(typeof t!="object")return t;var n;try{n=t.hashkey?t.hashkey:t.hashkey=e()}catch(r){}return n};return{put:function(e,r){t[n(e)]=r},get:function(e){return t[n(e)]},remove:function(e){delete t[n(e)]},getData:function(){return t},dispose:function(){for(var e in t)t[e]=null,delete t[e]}}}function A(e,t){var n=e.match(s.repeat);if(!n)return;var r=n[2],i=new $(r);return i.getValue(t)}function O(e,t,n){var r=e.match(s.repeat);if(!r)return;var i=r[1];t[i]=n}function M(e,t){var n=e.node||e.attribute.node,r=n.template.watchers,i=h(n.element)&&n.parent?n.parent.element:n.element,s=r.get(i),o=s?s:r.get(e.pattern);if(p(o)){var u=o(e.value,t,e.pattern,n.scope,n,e.attribute);if(d(u))return u}return t}function _(e,n,r,i,o,u){var a=n.split("."),f=e;if(a[0]!==""){var l=-1,c=a.length;while(++l<c){if(!f)return e._parent?_(e._parent,n,r,i,o,u):t;f=f[a[l]]}}if(!f)return e._parent?_(e._parent,n,r,i,o,u):t;if(!o)return!d(f[r])&&e._parent?_(e._parent,n,r,i,o,u):f[r];var h=[];if(d(i))if(u)h=u;else{var l=-1,c=i.length;while(++l<c){var v=i[l];if(v.match(s.quote))h.push(v.replace(s.quote,""));else{var m=new $(v);h.push(m.getValue(e))}}}return p(f[r])?f[r].apply(null,h):e._parent?_(e._parent,n,r,i,o,h):t}function D(e){var t=e.split("(")[0];return t.substr(0,t.lastIndexOf("."))}function P(e){var t=e.split("(")[0];return t.substring(t.lastIndexOf(".")).replace(".","")}function H(e){return S(e.split(s.params))}function B(e,t,n){var i=new W(e,t);i.previousSibling=e.previousSibling,i.nextSibling=e.nextSibling;var s=[];for(var o,u,a,f=e.attributes,l=0,c=f&&f.length;l<c;l++)o=f[l],o.specified&&(u=o.name,a=o.value,u===r.attributes.skip&&(i.skip=a===""||a==="true"),!n&&u===r.attributes.repeat&&(i.repeater=a),(j(u+":"+a)||u===r.attributes.repeat||u===r.attributes.show||u===r.attributes.hide||u===r.attributes.href||a.indexOf(r.attributes.cloak)!==-1)&&s.push(new X(u,a,i)));return i.attributes=s,i}function j(e){var t=e.match(s.token);return t&&t.length>0}function F(e){return s.content.test(e)}function I(e){if(!e)return;var t=e.nodeType;return!e||!t?!1:t===8?!1:t===3&&!F(e.nodeValue)&&!j(e.nodeValue)?!1:!0}function q(e,t,n,r){if(!I(t))return;var i;r?(i=r,i.parent=n):i=B(t,n?n.scope:new z),i.template=e;if(i.skip)return;var s=t.firstChild;while(s){var o=q(e,s,i);o&&(o.parent=i,i.children.push(o)),s=s.nextSibling}return i}function R(e,t){U(e);for(var n in t)e[n]=t[n]}function U(e){for(var t in e)t.substr(0,1)!=="_"&&(e[t]=null,delete e[t])}function Q(e){if(!c(e))return;var t=G(e);t&&(t.dispose(),t=null);var n=new K(e);return J.put(e,n),n}function G(e){return c(e)?J.get(e):null}function Y(){for(var e in J.getData())J.get(e).render()}e.template=e.source||{},e.template.version="0.0.1";var n=e.template.errors={COMPILE_NO_ELEMENT:"Error in soma.template, no target specified: template.source(element).compile(data).",REPEAT_WRONG_ARGUMENTS:"Error in soma.template, repeat attribute requires this syntax: 'item in items'."},r=e.template.settings=e.template.settings||{},i=r.tokens={start:"{{",end:"}}"},s=r.regex={sequence:new RegExp(i.start+".+?"+i.end+"|[^"+i.start+"]+","g"),token:new RegExp(i.start+".*?"+i.end,"g"),expression:new RegExp(i.start+"|"+i.end,"gm"),escape:/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,trim:/^[\s+]+|[\s+]+$/g,repeat:/(.*)\s+in\s+(.*)/,func:/(.*)\((.*)\)/,params:/,\s+|,|\s+,\s+/,quote:/\"|\'/g,content:/[^.|^\s]/gm},o=r.attributes={skip:"data-skip",repeat:"data-repeat",src:"data-src",href:"data-href",show:"data-show",hide:"data-hide",cloak:"data-cloak"},u=r.vars={index:"$index",key:"$key"},z=function(e){function t(e){var t=n(e);return t._parent=this,this._children.push(t),t}function n(e){var n={_parent:null,_children:[],_createChild:function(e){return t.apply(n,arguments)}};if(e&&f(e))for(var r in e)n[r]=e[r];return n}return n(e)},W=function(e,t){this.element=e,this.scope=t,this.attributes=null,this.value=null,this.interpolation=null,this.invalidate=!1,this.skip=!1,this.repeater=null,this.parent=null,this.children=[],this.childrenRepeater=[],this.previousSibling=null,this.nextSibling=null,this.template=null,h(this.element)&&(this.value=this.element.nodeValue,this.interpolation=new V(this.value,this))};W.prototype={toString:function(){return"[object Node]"},dispose:function(){},update:function(){if(b(this))return;d(this.interpolation)&&this.interpolation.update();if(d(this.attributes)){var e=-1,t=this.attributes.length;while(++e<t)this.attributes[e].interpolationName.update(),this.attributes[e].interpolationValue.update()}this.updateChildren()},updateChildren:function(){if(b(this)||this.repeater)return;var e=-1,t=this.children.length;while(++e<t)this.children[e].update()},invalidateData:function(){if(b(this))return;this.invalidate=!0;var e,t;if(this.attributes){e=-1,t=this.attributes.length;while(++e<t)this.attributes[e].invalidate=!0}e=-1,t=this.childrenRepeater.length;while(++e<t)this.childrenRepeater[e].invalidateData();e=-1,t=this.children.length;while(++e<t)this.children[e].invalidateData()},render:function(){if(b(this))return;this.invalidate&&(this.invalidate=!1,h(this.element)&&(this.element.nodeValue=this.interpolation.render()));if(this.attributes){var e=-1,t=this.attributes.length;while(++e<t)this.attributes[e].render()}this.repeater?this.renderRepeater():this.renderChildren()},renderChildren:function(){if(b(this))return;var e=-1,t=this.children.length;while(++e<t)this.children[e].render()},renderRepeater:function(){var e=A(this.repeater,this.scope);if(a(e)){var t=-1,n=e.length,r=this.childrenRepeater.length,i=n>r?n:r;while(++t<i)if(t<n){var s,o=this.childrenRepeater[t];if(!o){var f=this.element.cloneNode(!0),l=B(f,this.scope._createChild(),!0);l.template=this.template,this.childrenRepeater[t]=l,O(this.repeater,l.scope,e[t]),l.scope[u.index]=t,q(this.template,f,this.parent,l),l.update(),l.render(),s?N(s,f):this.previousSibling?N(this.previousSibling,f):this.nextSibling?T(this.nextSibling,f):this.parent.element.appendChild(f),s=l.element}else O(this.repeater,o.scope,e[t]),o.scope[u.index]=t,o.update(),o.render(),s=o.element}else this.parent.element.removeChild(this.childrenRepeater[t].element);this.childrenRepeater.length>e.length&&(this.childrenRepeater.length=e.length)}else{var c=-1;for(var h in e){c++;var s,o=this.childrenRepeater[c];if(!o){var f=this.element.cloneNode(!0),l=B(f,this.scope._createChild(),!0);l.template=this.template,this.childrenRepeater[c]=l,O(this.repeater,l.scope,e[h]),l.scope[u.key]=h,q(this.template,f,this.parent,l),l.update(),l.render(),s?N(s,f):this.previousSibling?N(this.previousSibling,f):this.nextSibling?T(this.nextSibling,f):this.parent.element.appendChild(f),s=l.element}else O(this.repeater,o.scope,e[h]),o.scope[u.key]=h,o.update(),o.render(),s=o.element}var p=c;while(c++<this.childrenRepeater.length-1)this.parent.element.removeChild(this.childrenRepeater[c].element);this.childrenRepeater.length=p+1}this.element.parentNode&&this.element.parentNode.removeChild(this.element)}};var X=function(e,t,n,r){this.name=e,this.value=t,this.node=n,this.interpolationName=new V(this.name,null,this),this.interpolationValue=new V(this.value,null,this),this.invalidate=!1};X.prototype={toString:function(){return"[object Attribute]"},render:function(){function t(t,n){t=="class"?e.className=n:e.setAttribute(t,n)}function n(t,n){e.setAttribute("src",n)}function i(t,n){e.setAttribute("href",n)}if(this.node.repeater)return;var e=this.node.element;this.invalidate&&(this.invalidate=!1,this.name=this.interpolationName.render()||this.name,this.value=this.interpolationValue.render()||this.value,this.name===o.src?n(this.name,this.value):this.name===o.href?i(this.name,this.value):t(this.name,this.value)),this.name==="class"&&this.value.indexOf(r.attributes.cloak)!==-1&&C(this.node.element,r.attributes.cloak),this.name===o.hide&&(e.style.display=!d(this.value)||this.value===""||this.value===!0||this.value==="true"?"none":"block"),this.name===o.show&&(e.style.display=!d(this.value)||this.value===""||this.value===!0||this.value==="true"?"block":"none")}};var V=function(e,t,n){this.value=t&&!h(t.element)?E(e):e,this.node=t,this.attribute=n,this.sequence=[],this.expressions=[];var r=this.value.match(s.sequence);if(r){var i=-1,o=r.length;while(++i<o)if(r[i].match(s.token)){var u=new $(x(r[i]),this.node,this.attribute);this.sequence.push(u),this.expressions.push(u)}else this.sequence.push(r[i]);S(this.sequence)}};V.prototype={toString:function(){return"[object Interpolation]"},update:function(){var e=-1,t=this.expressions.length;while(++e<t)this.expressions[e].update()},render:function(){var e="";if(this.sequence){var t=-1,n=this.sequence.length;while(++t<n){var r="";v(this.sequence[t])?r=this.sequence[t].value:r=this.sequence[t],d(r)||(r=""),e+=r}}return e}};var $=function(e,t,n){this.pattern=e,this.node=t,this.attribute=n,this.isFunction=y(this.pattern),this.path=D(this.pattern),this.accessor=P(this.pattern),this.params=this.isFunction?H(this.pattern.match(s.func)[2]):null,this.value,this.watchers=[]};$.prototype={toString:function(){return"[object Expression]"},update:function(){var e=this.node||this.attribute.node,t=this.getValue(e.scope);t=M(this,t),this.value!==t&&(this.value=t,(this.node||this.attribute).invalidate=!0)},getValue:function(e){return _(e,this.path,this.accessor,this.params,this.isFunction)}};var J=new L,K=function(e){this.watchers=new L,this.element=e,this.node,this.compile()};K.prototype={toString:function(){return"[object Template]"},compile:function(){this.node=q(this,this.element)},update:function(e){d(e)&&R(this.node.scope,e),this.node&&this.node.update()},render:function(e){this.update(e),this.node&&this.node.render()},invalidate:function(){this.node&&this.node.invalidateData()},watch:function(e,t){if(!l(e)&&!c(e))return;this.watchers.put(e,t)},dispose:function(){J.remove(this.element),this.watchers&&this.watchers.dispose(),this.node&&this.node.dispose(),this.element=null,this.watchers=null,this.node=null}},e.template.create=Q,e.template.get=G,e.template.renderAll=Y})(this.soma=this.soma||{});